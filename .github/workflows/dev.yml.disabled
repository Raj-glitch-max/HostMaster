name: Development CI

# Trigger: Push to 'dev' branch or PRs targeting 'dev'
on:
    push:
        branches: ["dev"]
    pull_request:
        branches: ["dev"]

# Permissions needed for token access
permissions:
    contents: read
    pull-requests: write

jobs:
    # 1. TEST JOB
    test:
        name: ğŸ§ª Unit & Integration Tests
        runs-on: ubuntu-latest

        # Service Containers (Postgres + Redis) for Integration Tests
        services:
            postgres:
                image: postgres:15-alpine
                env:
                    POSTGRES_DB: hostmaster_test
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: password
                ports:
                    - 5432:5432
                # Health check to ensure DB is ready before tests run
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

            redis:
                image: redis:7-alpine
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: ğŸ“¥ Checkout Code
              uses: actions/checkout@v4

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: backend/package-lock.json

            - name: ğŸ“¦ Install Backend Dependencies
              run: |
                  cd backend
                  npm ci

            - name: ğŸ§ª Run Tests
              run: |
                  cd backend
                  npm test
              env:
                  NODE_ENV: test
                  DB_HOST: localhost
                  DB_PORT: 5432
                  DB_NAME: hostmaster_test
                  DB_USER: postgres
                  DB_PASSWORD: password
                  REDIS_HOST: localhost
                  REDIS_PORT: 6379
                  JWT_SECRET: test_secret_key_12345
                  ENCRYPTION_KEY: 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef

    # 2. LINT JOB
    lint:
        name: ğŸ§¹ Linting & Formatting
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Lint Backend
              run: |
                  cd backend
                  npm ci
                  npm run lint --if-present

    # 3. BUILD JOB (Dry Run)
    build-check:
        name: ğŸ—ï¸ Build Verification
        runs-on: ubuntu-latest
        needs: [test, lint] # Only run if tests pass
        steps:
            - uses: actions/checkout@v4

            - name: ğŸ³ Build Docker Images
              run: |
                  docker build -f backend/Dockerfile -t hostmaster-backend:test ./backend
                  docker build -f frontend/Dockerfile -t hostmaster-frontend:test ./frontend
